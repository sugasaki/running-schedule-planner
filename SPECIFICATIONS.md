# ランニングスケジュールプランナー - 仕様書

## 概要
ランニングイベントのチェックポイント管理と時間計算を行うWebアプリケーション

## 主要機能

### 1. チェックポイント管理
- ドラッグ&ドロップによる行の順序変更
- チェックポイントの追加・編集・削除
- 場所名、区分（集合、スタート、ゴール等）の設定

### 2. 距離・間隔の自動計算システム

#### 2.1 基本仕様
- **距離列**: ユーザーが累積距離を入力（手動入力）
- **間隔列**: 前の行との距離差分を自動計算（読み取り専用）
- 計算式: `間隔[i] = 距離[i] - 距離[i-1]`

#### 2.2 自動再計算のタイミング
- **距離変更時**: 該当行および次の行の間隔を即座に再計算
- **ペース変更時**: 該当行から最終行までの時間計算を再実行
- **休憩時間変更時**: 該当行から最終行までの時間計算を再実行
- **行移動時**: 全ての行の間隔を即座に再計算
- **行追加/削除時**: 影響を受ける行の間隔を再計算

#### 2.3 データ検証とエラー表示システム

##### 2.3.1 エラー検出条件
- **距離逆転エラー**: 下の行の距離が上の行の距離より小さい場合

##### 2.3.2 エラー表示仕様
- **表示方法**: 該当行全体の背景色を赤色 (`#fee2e2`) に変更
- **複数エラー対応**: 複数行にエラーがある場合、すべての該当行を同時に赤色表示
- **エラー優先度**: エラー表示は区分別色分けより優先される

##### 2.3.3 エラーチェック実行タイミング
- **行移動後**: 全行を対象とした包括的チェック
- **距離編集後**: デバウンス処理（200ms）による最適化チェック
  - 連続した距離編集の最後の変更から200ms後に実行
  - パフォーマンス最適化とReact状態更新との競合回避

##### 2.3.4 IDベースの行識別システム
- **行移動対応**: Handsontableの表示順序とReact状態の不整合を解決
- **正確な更新**: IDを使用して正しいチェックポイントデータを特定・更新
- **データ整合性**: 行移動後も正確なエラーチェックと更新を保証

### 3. 時間計算システム

#### 3.1 計算ロジック
- スタート日時を基準に各チェックポイントの到着・出発時刻を算出
- 計算式: `移動時間 = 間隔 × ペース`
- 休憩時間を考慮した出発時刻の算出

#### 3.2 時刻表示形式
- 日付: `月/日` 形式
- 時刻: `時:分` 形式
- 日付をまたぐ長時間イベントに対応

### 4. プリセット管理

#### 4.1 プリセットカテゴリ
- `street-run`: 街ランコース
- `marathon`: マラソン・長距離イベント
- `training`: トレーニングプラン
- `custom`: ユーザーカスタム設定

#### 4.2 設定保存・読み込み
- JSON形式でのエクスポート・インポート
- LocalStorageによるカスタム設定の永続化

### 5. ユーザーインターフェース仕様

#### 5.1 グリッド操作

##### 5.1.1 行移動機能
- **移動方法**: 行番号をドラッグ&ドロップで移動
- **移動制限**: 最初の2行（集合・スタート）は移動不可
- **移動後処理**: 
  - 全行の距離エラーチェックを自動実行
  - 間隔の再計算は行わない（Handsontableの表示のみ変更）

##### 5.1.2 その他の操作
- **列移動**: No列（最初の列）は移動不可
- **列幅調整**: 列境界のドラッグで調整可能
- **右クリックメニュー**: 行の追加・削除機能

#### 5.2 セルの背景色仕様
- **通常セル**: 白色 (`#ffffff`)
- **読み取り専用セル**: 薄いグレー (`#f9fafb`)
- **エラー行**: 薄い赤色 (`#fee2e2`)
- **エラー行**: 濃い赤色 (`#fecaca`)
- **区分別色分け**:
  - 集合: 薄い緑色 (`#f0fdf4`)
  - スタート: 薄い青色 (`#eff6ff`)
  - ゴール: 薄い黄色 (`#fefce8`)
  - トイレ: 薄いピンク(`#ffe5ec`)

#### 5.3 列定義
1. **No**: 行番号（読み取り専用）
2. **場所**: チェックポイント名（テキスト入力）
3. **区分**: ドロップダウン選択（集合、スタート、トイレ、コンビニ、観光、休憩、ゴール、銭湯、打上げ）
4. **距離(km)**: 累積距離（数値入力、小数点2桁）
5. **ペース(分/km)**: 移動ペース（数値入力、小数点1桁）
6. **間隔(km)**: 区間距離（自動計算、読み取り専用）
7. **休憩(分)**: 休憩時間（数値入力、整数）
8. **日付**: 到着日付（自動計算、読み取り専用）
9. **到着**: 到着時刻（自動計算、読み取り専用）
10. **出発**: 出発時刻（自動計算、読み取り専用）

## 技術仕様

### 使用ライブラリ
- React 19 + TypeScript
- Handsontable (スプレッドシート機能)
- @dnd-kit (ドラッグ&ドロップ)
- Tailwind CSS (スタイリング)

### 主要ファイル構成

#### コンポーネント
- `RunningSchedulePlanner.tsx`: メインコンポーネント
- `HandsontableSchedule.tsx`: グリッドコンポーネント（リファクタリング済み）

#### テーブル関連モジュール（分離済み）
- `table/HandsontableConfig.ts`: カラム設定とバリデーション
- `table/HandsontableStyles.ts`: CSS スタイル定義
- `table/HandsontableUtils.ts`: データ変換とイベントハンドラー

#### その他
- `useTimeCalculations.ts`: 時間計算フック
- `ConfigManager.ts`: プリセット管理サービス

### 開発・ビルドコマンド
```bash
# 開発サーバー起動
pnpm dev

# 型チェック
pnpm type-check

# ESLintチェック
pnpm lint

# ビルド
pnpm build
```

## 制約事項

### データ制約
- **距離順序**: 距離は前の行以上の値である必要がある
- **保護行**: 最初の2行（集合・スタート）は削除・移動不可
- **読み取り専用列**: 間隔列、計算結果列（日付、到着、出発）は直接編集不可

### パフォーマンス制約
- **デバウンス処理**: 距離編集後のエラーチェックは200ms遅延
- **全行チェック**: 行移動時は全行を対象とした処理実行

### 技術制約
- **IDベース管理**: チェックポイントの識別と更新はID基準
- **状態同期**: Handsontableの表示状態とReact状態の分離管理